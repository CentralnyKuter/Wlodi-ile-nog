<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kalkulator Poboru Energii</title>
  <style>
    :root {
      --container-bg: rgba(30, 30, 30, 0.85);
      --button-bg: #FF9800;
      --button-hover: #E68900;
      --input-width: 40px;
      --button-size: 12px;
    }
    body {
      font-size: 14px;
      font-family: Arial, sans-serif;
      background: url('/Wlodi-ile-nog/images/2.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #ffffff;
      text-align: center;
      margin: 20px;
    }
    /* Kontener formularza – szeroki, aby zmieścić wszystkie kontrolki */
    .container {
      background: var(--container-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      text-align: left;
      width: 95%;
      max-width: 900px;
      margin: auto;
      margin-bottom: 20px;
    }
    .button {
      background-color: var(--button-bg);
      color: white;
      border: none;
      padding: 10px;
      margin-top: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      width: 48%;
      max-width: 250px;
    }
    .button:hover {
      background-color: var(--button-hover);
    }
    /* Ustawienia parametrów kratownicy – długość i szerokość obok siebie */
    .grid-params-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
    }
    .grid-length-container,
    .grid-width-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .grid-length-container label,
    .grid-width-container label {
      font-size: 1em;
      font-weight: bold;
    }
    /* Globalna opcja: odstępy liczone od środka urządzenia */
    .global-options {
      margin-bottom: 15px;
    }
    .global-options label {
      font-size: 1em;
      font-weight: bold;
    }
    /* Każdy wiersz urządzenia – wszystkie kontrolki w jednej linii */
    .device-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
      border: 1px solid #666;
      border-radius: 6px;
      padding: 5px;
    }
    .device-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1em;
      min-width: 220px;
    }
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .quantity-button {
      background-color: #555;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      font-size: var(--button-size);
      border-radius: 5px;
    }
    .quantity-input {
      width: var(--input-width);
      text-align: center;
      -moz-appearance: textfield;
    }
    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    /* Kontener wizualizacji */
    .visualization-container {
      width: 90%;
      max-width: 900px;
      margin: 20px auto;
      background: rgba(0,0,0,0.4);
      padding: 10px;
      border-radius: 6px;
    }
    .visualization-container h3 {
      text-align: center;
      margin: 0 0 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Choose your weapon!</h2>
    <!-- Ustawienia parametrów kratownicy -->
    <div class="grid-params-container">
      <div class="grid-length-container">
        <label for="grid-length-input">Długość kraty (m):</label>
        <div class="quantity-controls">
          <button class="quantity-button" id="grid-length-minus">−</button>
          <input type="number" id="grid-length-input" class="quantity-input" step="0.25" value="12" min="0" />
          <button class="quantity-button" id="grid-length-plus">+</button>
        </div>
      </div>
      <div class="grid-width-container">
        <label for="grid-width-select">Szerokość kraty (mm):</label>
        <select id="grid-width-select" class="quantity-input">
          <option value="290">290</option>
          <option value="400" selected>400</option>
          <option value="500">500</option>
        </select>
      </div>
    </div>
    <!-- Globalna opcja -->
    <div class="global-options">
      <label>
        <input type="checkbox" id="center-spacing" />
        Użyj odstępów liczone od środka urządzenia
      </label>
    </div>
    <div id="device-list"></div>
    <select id="device-select" style="min-width: 220px;"></select>
    <button class="button" onclick="addSelectedDevice()">Dodaj urządzenie</button>
    <button class="button" onclick="clearAll()">Clear all</button>
    <h3 id="total-energy">Całkowity pobór: 0 W</h3>
  </div>
  <!-- Wizualizacja – kratownica jako prostokąt, urządzenia umieszczone pod kratą -->
  <div class="visualization-container">
    <h3>Wizualizacja rozmieszczenia</h3>
    <svg id="truss-visualization" width="900" height="550" style="border:1px solid #fff;"></svg>
  </div>
  <script>
    let devices = [];           // wybrane urządzenia
    let availableDevices = [];  // urządzenia dostępne do dodania
    let allDevices = [];        // wszystkie urządzenia (JSON)
    let gridLength = 12;        // długość kraty w m
    let gridWidth = 400;        // szerokość kraty w mm
    let useCenterSpacing = false; // globalny tryb: odstępy od środka (domyślnie false)

    const colorPalette = [
      "#e6194b","#3cb44b","#ffe119","#0082c8","#f58231","#911eb4",
      "#46f0f0","#f032e6","#d2f53c","#fabebe","#008080","#e6beff",
      "#aa6e28","#fffac8","#800000","#aaffc3","#808000","#ffd8b1",
      "#000080","#808080","#000000"
    ];

    function saveState() {
      const state = {
        devices: devices.map(device => {
          const quantityInput = document.getElementById('quantity-' + device.id);
          const checkbox = document.getElementById('device-' + device.id);
          const intervalInput = document.getElementById('interval-' + device.id);
          return {
            id: device.id,
            quantity: quantityInput ? +quantityInput.value : 0,
            isChecked: checkbox ? checkbox.checked : true,
            interval: intervalInput ? +intervalInput.value : 1.0
          };
        }),
        availableDevicesIds: availableDevices.map(device => device.id),
        gridLength: gridLength,
        gridWidth: gridWidth,
        useCenterSpacing: useCenterSpacing
      };
      localStorage.setItem('deviceState', JSON.stringify(state));
    }

    function restoreState() {
      const savedState = localStorage.getItem('deviceState');
      if (!savedState) return;
      const state = JSON.parse(savedState);
      state.devices.forEach(savedDevice => {
        const device = allDevices.find(d => d.id === savedDevice.id);
        if (device && !devices.find(d => d.id === device.id)) {
          devices.push(device);
        }
      });
      if (state.availableDevicesIds) {
        availableDevices = allDevices.filter(d => state.availableDevicesIds.includes(d.id));
      }
      if (typeof state.gridLength === 'number') {
        gridLength = state.gridLength;
        document.getElementById('grid-length-input').value = gridLength;
      }
      if (typeof state.gridWidth === 'number') {
        gridWidth = state.gridWidth;
        document.getElementById('grid-width-select').value = gridWidth;
      }
      if (typeof state.useCenterSpacing === 'boolean') {
        useCenterSpacing = state.useCenterSpacing;
        document.getElementById('center-spacing').checked = useCenterSpacing;
      }
      renderDeviceList();
      populateDeviceSelection();
      state.devices.forEach(savedDevice => {
        const quantityInput = document.getElementById('quantity-' + savedDevice.id);
        const checkbox = document.getElementById('device-' + savedDevice.id);
        const intervalInput = document.getElementById('interval-' + savedDevice.id);
        if (quantityInput) quantityInput.value = savedDevice.quantity;
        if (checkbox) checkbox.checked = savedDevice.isChecked;
        if (intervalInput) intervalInput.value = savedDevice.interval;
      });
      calculateEnergy();
    }

    function populateDeviceSelection() {
      const select = document.getElementById('device-select');
      select.innerHTML = '';
      if (availableDevices.length === 0) {
        select.style.display = 'none';
        return;
      } else {
        select.style.display = 'inline-block';
      }
      availableDevices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.id;
        option.textContent = device.nazwa;
        select.appendChild(option);
      });
    }

    function renderDeviceList() {
      const listDiv = document.getElementById('device-list');
      listDiv.innerHTML = '';
      devices.forEach(device => addDeviceToList(device));
    }

    function addDeviceToList(device) {
      const container = document.createElement('div');
      container.classList.add('device-container');
      
      const labelContainer = document.createElement('div');
      labelContainer.classList.add('device-label');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = device.pobor;
      checkbox.id = 'device-' + device.id;
      checkbox.checked = true;
      checkbox.addEventListener('change', () => { calculateEnergy(); saveState(); });
      const label = document.createElement('label');
      label.textContent = `${device.nazwa} (${device.pobor} W)`;
      labelContainer.appendChild(checkbox);
      labelContainer.appendChild(label);
      
      const quantityContainer = document.createElement('div');
      quantityContainer.classList.add('quantity-controls');
      const minusButton = document.createElement('button');
      minusButton.textContent = "−";
      minusButton.classList.add('quantity-button');
      minusButton.onclick = function () {
        let input = document.getElementById('quantity-' + device.id);
        if (+input.value > 0) {
          input.value = +input.value - 1;
          calculateEnergy();
          saveState();
        }
      };
      const quantityInput = document.createElement('input');
      quantityInput.type = 'number';
      quantityInput.value = 0;
      quantityInput.min = 0;
      quantityInput.id = 'quantity-' + device.id;
      quantityInput.classList.add('quantity-input');
      quantityInput.oninput = function () { calculateEnergy(); saveState(); };
      const plusButton = document.createElement('button');
      plusButton.textContent = "+";
      plusButton.classList.add('quantity-button');
      plusButton.onclick = function () {
        let input = document.getElementById('quantity-' + device.id);
        input.value = +input.value + 1;
        calculateEnergy();
        saveState();
      };
      quantityContainer.appendChild(minusButton);
      quantityContainer.appendChild(quantityInput);
      quantityContainer.appendChild(plusButton);
      
      const intervalContainer = document.createElement('div');
      intervalContainer.classList.add('quantity-controls');
      const minusIntervalButton = document.createElement('button');
      minusIntervalButton.textContent = "−";
      minusIntervalButton.classList.add('quantity-button');
      minusIntervalButton.onclick = function () {
        let intervalInput = document.getElementById('interval-' + device.id);
        let val = parseFloat(intervalInput.value) || 0;
        if (val > 0) {
          val = (val - 0.1).toFixed(1);
          if(val < 0) val = 0;
          intervalInput.value = val;
          calculateEnergy();
          saveState();
        }
      };
      const intervalInput = document.createElement('input');
      intervalInput.type = 'number';
      intervalInput.value = 1.0;
      intervalInput.min = 0;
      intervalInput.step = 0.1;
      intervalInput.id = 'interval-' + device.id;
      intervalInput.classList.add('quantity-input');
      intervalInput.oninput = function () { calculateEnergy(); saveState(); };
      const plusIntervalButton = document.createElement('button');
      plusIntervalButton.textContent = "+";
      plusIntervalButton.classList.add('quantity-button');
      plusIntervalButton.onclick = function () {
        let intervalInputElem = document.getElementById('interval-' + device.id);
        let val = parseFloat(intervalInputElem.value) || 0;
        val = (val + 0.1).toFixed(1);
        intervalInputElem.value = val;
        calculateEnergy();
        saveState();
      };
      intervalContainer.appendChild(minusIntervalButton);
      intervalContainer.appendChild(intervalInput);
      intervalContainer.appendChild(plusIntervalButton);
      
      container.appendChild(labelContainer);
      container.appendChild(quantityContainer);
      container.appendChild(intervalContainer);
      document.getElementById('device-list').appendChild(container);
    }

    function addSelectedDevice() {
      const select = document.getElementById('device-select');
      const selectedId = parseInt(select.value);
      const selectedDevice = availableDevices.find(d => d.id === selectedId);
      if (!selectedDevice) return;
      if (!devices.find(d => d.id === selectedId)) {
        devices.push(selectedDevice);
      }
      availableDevices = availableDevices.filter(d => d.id !== selectedId);
      renderDeviceList();
      populateDeviceSelection();
      calculateEnergy();
      saveState();
    }

    function calculateEnergy() {
      let totalPower = 0;
      devices.forEach(device => {
        const checkbox = document.getElementById('device-' + device.id);
        const quantityInput = document.getElementById('quantity-' + device.id);
        if (checkbox && checkbox.checked && quantityInput) {
          const qty = parseInt(quantityInput.value) || 0;
          totalPower += device.pobor * qty;
        }
      });
      document.getElementById('total-energy').textContent = `Całkowity pobór: ${totalPower} W`;
      updateTrussVisualization();
    }

    // Rysujemy kratownicę jako prostokąt z zachowaniem proporcji:
    // - Skala: svgWidth / gridLength (px/m)
    // - Wysokość kratownicy: (gridWidth / 1000) * scale
    // Urządzenia umieszczamy tak, że ich górne krawędzie są dokładnie 5px poniżej dolnej krawędzi kratownicy.
    // W trybie domyślnym odstępy liczone są od końca urządzenia.
    // W trybie "od środka" odstępy są liczone od środka urządzenia, czyli:
    //   - Środek każdego egzemplarza jest rozmieszczany w odstępach równych (interval * scale),
    //     a lewy brzeg ustalamy jako (środek - devWidthPx/2).
    // Obrazek dla "Robe 800" jest traktowany analogicznie – jego pozycjonowanie odbywa się w zależności od trybu.
    function updateTrussVisualization() {
      const svg = document.getElementById('truss-visualization');
      while (svg.firstChild) { svg.removeChild(svg.firstChild); }
      const svgWidth = svg.clientWidth;
      const svgHeight = svg.clientHeight;
      
      // Skala: piksele na metr (dla długości kratownicy)
      const scale = svgWidth / gridLength;
      // Obliczamy wysokość kratownicy (przeliczając mm na m)
      const rectHeight = (gridWidth / 1000) * scale;
      
      // Rysujemy kratownicę od 20px od góry
      const rectY = 20;
      const trussRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      trussRect.setAttribute("x", "0");
      trussRect.setAttribute("y", rectY);
      trussRect.setAttribute("width", svgWidth);
      trussRect.setAttribute("height", rectHeight);
      trussRect.setAttribute("fill", "#222");
      trussRect.setAttribute("stroke", "#fff");
      trussRect.setAttribute("stroke-width", "2");
      svg.appendChild(trussRect);
      
      // Ustalamy, że górna krawędź urządzeń ma być dokładnie 5px poniżej dolnej krawędzi kratownicy
      const devicesTop = rectY + rectHeight + 5;
      const centerX = svgWidth / 2;
      
      // Grupujemy urządzenia wg typu – każda grupa dotyczy jednego typu urządzenia
      let groups = [];
      devices.forEach(device => {
        const checkbox = document.getElementById('device-' + device.id);
        const quantityInput = document.getElementById('quantity-' + device.id);
        const intervalInput = document.getElementById('interval-' + device.id);
        if (checkbox && checkbox.checked && quantityInput && intervalInput) {
          const qty = parseInt(quantityInput.value) || 0;
          if (qty > 0) {
            const intervalM = parseFloat(intervalInput.value) || 0;
            // Obliczamy szerokość urządzenia (szerokość w cm -> m -> px)
            const devWidthM = device.szer * 0.01;
            const devWidthPx = devWidthM * scale;
            // Obliczamy standardową wysokość urządzenia (w cm -> m -> px)
            let devHeightPx = device.wys * 0.01 * scale;
            // Jeśli urządzenie to "Robe 800", przyjmujemy takie same obliczenie wysokości jak dla innych
            const isRobe800 = device.nazwa.indexOf("Robe 800") !== -1;
            // Obliczamy groupWidth – w zależności od trybu
            let groupWidth;
            if (!useCenterSpacing) {
              // Standardowy tryb: odstępy liczone od końca urządzenia
              groupWidth = qty * devWidthPx + (qty - 1) * (intervalM * scale);
            } else {
              // Tryb od środka: odległość między środkami urządzeń wynosi (intervalM * scale),
              // a groupWidth = devWidthPx + (qty - 1) * (intervalM * scale)
              groupWidth = devWidthPx + (qty - 1) * (intervalM * scale);
            }
            groups.push({ device, qty, intervalM, groupWidth, devWidthPx, devHeightPx });
          }
        }
      });
      
      if (groups.length === 0) return;
      
      // Dla każdej grupy, umieszczamy ją wycentrowaną względem całej szerokości SVG.
      groups.forEach(group => {
        if (!useCenterSpacing) {
          // Standardowy tryb: rozmieszczamy egzemplarze sekwencyjnie
          let xStart = centerX - (group.groupWidth / 2);
          for (let i = 0; i < group.qty; i++) {
            const isRobe800 = group.device.nazwa.indexOf("Robe 800") !== -1;
            if (isRobe800) {
              const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
              img.setAttribute("x", xStart);
              img.setAttribute("y", devicesTop);
              img.setAttribute("width", group.devWidthPx);
              img.setAttribute("height", group.devHeightPx);
              img.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", "/Wlodi-ile-nog/images/800.png");
              svg.appendChild(img);
              const devLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
              devLabel.setAttribute("x", xStart + group.devWidthPx / 2);
              devLabel.setAttribute("y", devicesTop - 5);
              devLabel.setAttribute("text-anchor", "middle");
              devLabel.setAttribute("font-size", "10");
              devLabel.setAttribute("fill", "#fff");
              devLabel.textContent = group.device.nazwa;
              svg.appendChild(devLabel);
            } else {
              const devRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
              devRect.setAttribute("x", xStart);
              devRect.setAttribute("y", devicesTop);
              devRect.setAttribute("width", group.devWidthPx);
              devRect.setAttribute("height", group.devHeightPx);
              const color = colorPalette[(group.device.id - 1) % colorPalette.length];
              devRect.setAttribute("fill", color);
              svg.appendChild(devRect);
              const devLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
              devLabel.setAttribute("x", xStart + group.devWidthPx / 2);
              devLabel.setAttribute("y", devicesTop - 5);
              devLabel.setAttribute("text-anchor", "middle");
              devLabel.setAttribute("font-size", "10");
              devLabel.setAttribute("fill", "#fff");
              devLabel.textContent = group.device.nazwa;
              svg.appendChild(devLabel);
            }
            xStart += group.devWidthPx;
            if (i < group.qty - 1) {
              xStart += group.intervalM * scale;
            }
          }
        } else {
          // Tryb od środka: rozmieszczamy egzemplarze tak, że ich środki są oddalone o (intervalM * scale)
          // Obliczamy grupę, jako: groupWidth = devWidthPx + (qty - 1) * (intervalM * scale)
          let xStart = centerX - (group.groupWidth / 2);
          for (let i = 0; i < group.qty; i++) {
            const centerPos = xStart + (i * (group.intervalM * scale));
            const leftEdge = centerPos - (group.devWidthPx / 2);
            const isRobe800 = group.device.nazwa.indexOf("Robe 800") !== -1;
            if (isRobe800) {
              const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
              img.setAttribute("x", leftEdge);
              img.setAttribute("y", devicesTop);
              img.setAttribute("width", group.devWidthPx);
              img.setAttribute("height", group.devHeightPx);
              img.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", "/Wlodi-ile-nog/images/800.png");
              svg.appendChild(img);
              const devLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
              devLabel.setAttribute("x", leftEdge + group.devWidthPx / 2);
              devLabel.setAttribute("y", devicesTop - 5);
              devLabel.setAttribute("text-anchor", "middle");
              devLabel.setAttribute("font-size", "10");
              devLabel.setAttribute("fill", "#fff");
              devLabel.textContent = group.device.nazwa;
              svg.appendChild(devLabel);
            } else {
              const devRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
              devRect.setAttribute("x", leftEdge);
              devRect.setAttribute("y", devicesTop);
              devRect.setAttribute("width", group.devWidthPx);
              devRect.setAttribute("height", group.devHeightPx);
              const color = colorPalette[(group.device.id - 1) % colorPalette.length];
              devRect.setAttribute("fill", color);
              svg.appendChild(devRect);
              const devLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
              devLabel.setAttribute("x", leftEdge + group.devWidthPx / 2);
              devLabel.setAttribute("y", devicesTop - 5);
              devLabel.setAttribute("text-anchor", "middle");
              devLabel.setAttribute("font-size", "10");
              devLabel.setAttribute("fill", "#fff");
              devLabel.textContent = group.device.nazwa;
              svg.appendChild(devLabel);
            }
          }
        }
      });
    }

    function clearAll() {
      localStorage.removeItem('deviceState');
      if (allDevices.length > 0) {
        devices = allDevices.slice(0, 5);
        availableDevices = allDevices.slice(5);
      } else {
        devices = [];
        availableDevices = [];
      }
      gridLength = 12;
      gridWidth = 400;
      document.getElementById('grid-length-input').value = gridLength;
      document.getElementById('grid-width-select').value = gridWidth;
      renderDeviceList();
      populateDeviceSelection();
      calculateEnergy();
    }

    function initGridLengthControls() {
      const minusBtn = document.getElementById('grid-length-minus');
      const plusBtn = document.getElementById('grid-length-plus');
      const lengthInput = document.getElementById('grid-length-input');
      minusBtn.addEventListener('click', () => {
        let currentValue = parseFloat(lengthInput.value);
        if (currentValue > 0) {
          currentValue = (currentValue - 0.25).toFixed(2);
          if(currentValue < 0) currentValue = 0;
          lengthInput.value = currentValue;
          gridLength = parseFloat(lengthInput.value);
          saveState();
          calculateEnergy();
        }
      });
      plusBtn.addEventListener('click', () => {
        let currentValue = parseFloat(lengthInput.value);
        currentValue = (currentValue + 0.25).toFixed(2);
        lengthInput.value = currentValue;
        gridLength = parseFloat(lengthInput.value);
        saveState();
        calculateEnergy();
      });
      lengthInput.addEventListener('input', () => {
        gridLength = parseFloat(lengthInput.value) || 0;
        saveState();
        calculateEnergy();
      });
    }

    function initGridWidthControl() {
      const widthSelect = document.getElementById('grid-width-select');
      widthSelect.addEventListener('change', () => {
        gridWidth = parseInt(widthSelect.value);
        saveState();
        calculateEnergy();
      });
    }

    // Inicjalizacja globalnego checkboxa dla trybu "od środka"
    document.getElementById('center-spacing').addEventListener('change', (e) => {
      useCenterSpacing = e.target.checked;
      saveState();
      calculateEnergy();
    });

    window.onload = function() {
      fetch('/Wlodi-ile-nog/data/devices.json')
        .then(response => response.json())
        .then(data => {
          allDevices = data;
          devices = allDevices.slice(0, 5);
          availableDevices = allDevices.slice(5);
          renderDeviceList();
          populateDeviceSelection();
          initGridLengthControls();
          initGridWidthControl();
          restoreState();
          calculateEnergy();
        })
        .catch(error => console.error("Błąd ładowania danych:", error));
    };
  </script>
</body>
</html>

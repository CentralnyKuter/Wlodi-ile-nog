<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kalkulator Poboru Energii</title>
  <style>
    :root {
      --container-bg: rgba(30, 30, 30, 0.85);
      --button-bg: #FF9800;
      --button-hover: #E68900;
      --input-width: 30px;
      --button-size: 10px;
    }

    body {
      font-size: 12px;
      font-family: Arial, sans-serif;
      background: url('/Wlodi-ile-nog/images/2.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #ffffff;
      text-align: center;
      margin: 20px;
    }

    .container {
      background: var(--container-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      text-align: left;
      width: 90%;
      max-width: 350px;
      margin: auto;
      margin-bottom: 20px;
    }

    .button {
      background-color: var(--button-bg);
      color: white;
      border: none;
      padding: 10px;
      margin-top: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      width: 50%;
      max-width: 250px;
    }

    .button:hover {
      background-color: var(--button-hover);
    }

    .device-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
    }

    .device-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1em;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .quantity-button {
      background-color: #666;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      font-size: var(--button-size);
      border-radius: 5px;
    }

    .quantity-input {
      width: var(--input-width);
      text-align: center;
      -moz-appearance: textfield;
    }

    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .grid-length-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
    }
    .grid-length-label {
      font-size: 1em;
      margin-right: 10px;
      flex: 1;
    }

    /* Kontener na wizualizację kraty */
    .visualization-container {
      width: 90%;
      max-width: 700px;
      margin: 20px auto;
      background: rgba(0,0,0,0.4);
      padding: 10px;
      border-radius: 6px;
    }
    .visualization-container h3 {
      text-align: center;
      margin: 0 0 10px 0;
    }

    @media (max-width: 200px) {
      .container {
        width: 95%;
      }
      .button {
        padding: 12px;
        font-size: 1em;
        max-width: none;
      }
      .quantity-input {
        width: 45px;
      }
      .device-container {
        flex-direction: column;
        align-items: center;
      }
      .grid-length-container {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Choose your weapon!</h2>

    <!-- Sekcja do ustawiania długości kraty -->
    <div class="grid-length-container">
      <div class="grid-length-label">Długość kraty (m):</div>
      <div class="quantity-controls">
        <button class="quantity-button" id="grid-length-minus">−</button>
        <input 
          type="number" 
          id="grid-length-input" 
          class="quantity-input" 
          step="0.25"
          value="12" 
          min="0" 
          style="width: 50px;" 
        />
        <button class="quantity-button" id="grid-length-plus">+</button>
      </div>
    </div>

    <div id="device-list"></div>

    <select id="device-select"></select>
    <button class="button" onclick="addSelectedDevice()">Dodaj urządzenie</button>
    <button class="button" onclick="clearAll()">Clear all</button>
    <h3 id="total-energy">Całkowity pobór: 0 W</h3>
  </div>

  <!-- Kontener na naszą wizualizację -->
  <div class="visualization-container">
    <h3>Wizualizacja rozmieszczenia</h3>
    <!-- SVG, w którym będziemy rysować kratę i urządzenia -->
    <svg id="truss-visualization" width="600" height="100" style="border:1px solid #fff;"></svg>
  </div>

  <script>
    let devices = [];
    let availableDevices = [];
    let allDevices = [];

    // Domyślnie 12m
    let gridLength = 12;

    // Zapis stanu do localStorage
    function saveState() {
      const state = {
        devices: devices.map(device => {
          const quantityInput = document.getElementById('quantity-' + device.id);
          const checkbox = document.getElementById('device-' + device.id);
          return {
            id: device.id,
            quantity: quantityInput ? quantityInput.value : 0,
            isChecked: checkbox ? checkbox.checked : true
          };
        }),
        availableDevicesIds: availableDevices.map(device => device.id),
        gridLength: gridLength
      };
      localStorage.setItem('deviceState', JSON.stringify(state));
    }

    // Odtwarzanie stanu z localStorage
    function restoreState() {
      const savedState = localStorage.getItem('deviceState');
      if (savedState) {
        const state = JSON.parse(savedState);

        // Przywracanie urządzeń
        state.devices.forEach(savedDevice => {
          const device = allDevices.find(d => d.id === savedDevice.id);
          if (device) {
            // jeśli w devices nie ma tego urządzenia, to je dodajemy
            if (!devices.find(d => d.id === device.id)) {
              addDeviceToList(device);
              devices.push(device);
            }
            const quantityInput = document.getElementById('quantity-' + device.id);
            const checkbox = document.getElementById('device-' + device.id);
            if (quantityInput) {
              quantityInput.value = savedDevice.quantity;
            }
            if (checkbox) {
              checkbox.checked = savedDevice.isChecked;
            }
          }
        });

        // Przywracanie listy dostępnych urządzeń
        if(state.availableDevicesIds) {
          availableDevices = allDevices.filter(d => state.availableDevicesIds.indexOf(d.id) !== -1);
        }

        // Przywracanie długości kraty
        if (typeof state.gridLength === 'number') {
          gridLength = state.gridLength;
          document.getElementById('grid-length-input').value = gridLength;
        }

        populateDeviceSelection();
        calculateEnergy();
      }
    }

    function populateDeviceSelection() {
      const select = document.getElementById('device-select');
      select.innerHTML = '';

      if (availableDevices.length === 0) {
        select.style.display = 'none';
        return;
      } else {
        select.style.display = 'inline-block';
      }

      availableDevices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.id;
        option.textContent = device.nazwa;
        select.appendChild(option);
      });
    }

    function renderDeviceList() {
      const listDiv = document.getElementById('device-list');
      listDiv.innerHTML = '';
      devices.forEach(device => addDeviceToList(device));
    }

    // Dodaje pojedynczy "blok" urządzenia do listy
    function addDeviceToList(device) {
      const container = document.createElement('div');
      container.classList.add('device-container');

      const labelContainer = document.createElement('div');
      labelContainer.classList.add('device-label');

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = device.pobor;
      checkbox.id = 'device-' + device.id;
      checkbox.checked = true;
      checkbox.addEventListener('change', () => {
        calculateEnergy();
        saveState();
      });

      const label = document.createElement('label');
      label.textContent = `${device.nazwa} (${device.pobor} W)`;

      const quantityContainer = document.createElement('div');
      quantityContainer.classList.add('quantity-controls');

      const minusButton = document.createElement('button');
      minusButton.textContent = "−";
      minusButton.classList.add('quantity-button');
      minusButton.onclick = function () {
        let input = document.getElementById('quantity-' + device.id);
        if (input.value > 0) {
          input.value--;
          calculateEnergy();
          saveState();
        }
      };

      const quantityInput = document.createElement('input');
      quantityInput.type = 'number';
      quantityInput.value = 0; // Domyślna wartość
      quantityInput.min = 0;
      quantityInput.id = 'quantity-' + device.id;
      quantityInput.classList.add('quantity-input');
      quantityInput.oninput = function () {
        calculateEnergy();
        saveState();
      };

      const plusButton = document.createElement('button');
      plusButton.textContent = "+";
      plusButton.classList.add('quantity-button');
      plusButton.onclick = function () {
        let input = document.getElementById('quantity-' + device.id);
        input.value++;
        calculateEnergy();
        saveState();
      };

      labelContainer.appendChild(checkbox);
      labelContainer.appendChild(label);
      quantityContainer.appendChild(minusButton);
      quantityContainer.appendChild(quantityInput);
      quantityContainer.appendChild(plusButton);

      container.appendChild(labelContainer);
      container.appendChild(quantityContainer);
      document.getElementById('device-list').appendChild(container);
    }

    // Dodaje urządzenie (z selecta) do listy wybranych
    function addSelectedDevice() {
      const select = document.getElementById('device-select');
      const selectedId = select.value;
      const selectedDevice = availableDevices.find(d => d.id == selectedId);
      if (!selectedDevice) return;

      addDeviceToList(selectedDevice);
      availableDevices = availableDevices.filter(d => d.id != selectedId);
      devices.push(selectedDevice);
      
      populateDeviceSelection();
      calculateEnergy();
      saveState();
    }

    // Funkcja wyliczająca pobór energii i aktualizująca wizualizację
    function calculateEnergy() {
      let totalPower = 0;
      devices.forEach(device => {
        const checkbox = document.getElementById('device-' + device.id);
        const quantityInput = document.getElementById('quantity-' + device.id);
        if (checkbox && checkbox.checked && quantityInput) {
          const qty = parseInt(quantityInput.value);
          totalPower += parseInt(device.pobor) * qty;
        }
      });
      document.getElementById('total-energy').textContent = `Całkowity pobór: ${totalPower} W`;

      updateTrussVisualization();
    }

    // Wizualizacja na kracie (w SVG)
    function updateTrussVisualization() {
      const svg = document.getElementById('truss-visualization');
      // Czyścimy poprzednie elementy
      while (svg.firstChild) {
        svg.removeChild(svg.firstChild);
      }

      // Wymiary SVG
      const svgWidth = svg.clientWidth;  // np. 600
      const svgHeight = svg.clientHeight; // np. 100

      // skala w px/m
      const scale = svgWidth / gridLength; 

      // Zbierz wszystkie obiekty (powtarzając je tyle razy, ile quantity)
      let selectedItems = [];
      devices.forEach(device => {
        const checkbox = document.getElementById('device-' + device.id);
        const quantityInput = document.getElementById('quantity-' + device.id);
        if (checkbox && checkbox.checked && quantityInput) {
          let qty = parseInt(quantityInput.value);
          for (let i = 0; i < qty; i++) {
            selectedItems.push(device);
          }
        }
      });

      // Jeśli nic nie wybrane, to nic nie rysujemy
      if (selectedItems.length === 0) return;

      // Każde urządzenie ma 'szer' = 40 cm = 0.4 m
      // (jeśli w JSON jest 40 i interpretujemy to jako cm)
      // Dla bezpieczeństwa przeliczmy:
      const deviceWidthM = 0.01 * selectedItems[0].szer; // 40 * 0.01 => 0.4 m
      // UWAGA: zakładamy, że wszystkie urządzenia mają taką samą szerokość (tak jest w JSON-ie)
      
      const deviceWidthPx = deviceWidthM * scale;

      // Całkowita szerokość potrzebna w pikselach
      const totalWidthPx = selectedItems.length * deviceWidthPx;

      // Wyznaczamy xStart, żeby całość była wycentrowana w poziomie
      const centerX = svgWidth / 2;
      let xStart = centerX - (totalWidthPx / 2);

      // Rysujemy "kratę" jako linię bazową (opcjonalnie)
      // (np. linia z x=0 do x=svgWidth na środku wysokości)
      const lineY = svgHeight / 2;
      const trussLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
      trussLine.setAttribute("x1", "0");
      trussLine.setAttribute("y1", lineY);
      trussLine.setAttribute("x2", svgWidth);
      trussLine.setAttribute("y2", lineY);
      trussLine.setAttribute("stroke", "#ccc");
      trussLine.setAttribute("stroke-width", "2");
      svg.appendChild(trussLine);

      // Rysujemy prostokąty symbolizujące urządzenia (jeden za drugim)
      selectedItems.forEach(device => {
        // Utworzenie "rect"
        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rect.setAttribute("x", xStart);
        rect.setAttribute("y", lineY - 20); // np. 20px wyżej, by środek był na linii
        rect.setAttribute("width", deviceWidthPx);
        rect.setAttribute("height", 40);  // symboliczna wysokość
        rect.setAttribute("fill", "orange"); // kolorek poglądowy

        // Ewentualnie klasa CSS do stylowania, np. rect.classList.add("device-rect");
        svg.appendChild(rect);

        // Dodajemy napis (nazwa lub ID)
        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", xStart + deviceWidthPx / 2);
        label.setAttribute("y", lineY - 25);
        label.setAttribute("text-anchor", "middle");
        label.setAttribute("font-size", "10");
        label.setAttribute("fill", "#fff");
        label.textContent = device.nazwa;
        svg.appendChild(label);

        xStart += deviceWidthPx;
      });
    }

    // Funkcja czyszcząca stan aplikacji i localStorage
    function clearAll() {
      localStorage.removeItem('deviceState');
      if (allDevices.length > 0) {
        devices = allDevices.slice(0, 5);
        availableDevices = allDevices.slice(5);
      } else {
        devices = [];
        availableDevices = [];
      }
      // Przywracamy domyślną długość kraty
      gridLength = 12;
      document.getElementById('grid-length-input').value = gridLength;

      renderDeviceList();
      populateDeviceSelection();
      calculateEnergy();  // to też wyczyści wizualizację
    }

    // Obsługa przycisków dla długości kraty
    function initGridLengthControls() {
      const minusBtn = document.getElementById('grid-length-minus');
      const plusBtn = document.getElementById('grid-length-plus');
      const lengthInput = document.getElementById('grid-length-input');

      minusBtn.addEventListener('click', () => {
        let currentValue = parseFloat(lengthInput.value);
        if (currentValue > 0) {
          currentValue = (currentValue - 0.25).toFixed(2);
          lengthInput.value = currentValue < 0 ? 0 : currentValue;
          gridLength = parseFloat(lengthInput.value);
          saveState();
          calculateEnergy();
        }
      });

      plusBtn.addEventListener('click', () => {
        let currentValue = parseFloat(lengthInput.value);
        currentValue = (currentValue + 0.25).toFixed(2);
        lengthInput.value = currentValue;
        gridLength = parseFloat(lengthInput.value);
        saveState();
        calculateEnergy();
      });

      lengthInput.addEventListener('input', () => {
        gridLength = parseFloat(lengthInput.value) || 0;
        saveState();
        calculateEnergy();
      });
    }

    window.onload = function() {
      // Ładujemy dane z pliku JSON (zmień na swoją ścieżkę lub wstaw dane "ręcznie")
      fetch('/Wlodi-ile-nog/data/devices.json')
        .then(response => response.json())
        .then(data => {
          allDevices = data;
          // Początkowo np. pierwsze 5 na liście w "devices", reszta w "availableDevices"
          devices = allDevices.slice(0, 5);
          availableDevices = allDevices.slice(5);
          renderDeviceList();
          populateDeviceSelection();
          initGridLengthControls(); // Inicjujemy obsługę kraty
          restoreState();           // Przywracamy stan z localStorage (o ile istnieje)
          calculateEnergy();        // Aktualizujemy (pobór + wizualizację)
        })
        .catch(error => console.error("Błąd ładowania danych:", error));
    };
  </script>
</body>
</html>
